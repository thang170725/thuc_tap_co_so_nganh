{% extends 'base.html' %}
{% load static %}

{% block title %}Gán Sinh viên - {{ class_obj.classId }}{% endblock title %}

<!-- 1. CSS cho 2 cột và thanh search -->
{% block page_css %}
<style>
    .manage-container { display: flex; gap: 20px; }
    .student-list-box { flex: 1; border: 1px solid #ddd; border-radius: 8px; }
    .student-list-box h4 {
        padding: 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
        border-radius: 8px 8px 0 0;
    }
    .student-list-content { padding: 15px; max-height: 500px; overflow-y: auto; }
    .student-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    .student-item:last-child { border-bottom: none; }
    .student-item span { font-size: 0.9em; color: #555; }
    .student-item .btn {
        padding: 4px 8px;
        font-size: 0.9em;
        text-decoration: none;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .btn-add { background-color: #28a745; }
    .btn-remove { background-color: #dc3545; }
    #search-available {
        width: 95%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
</style>
{% endblock %}

<!-- 2. Lấp đầy sidebar của Admin -->
{% block role_specific_links %}
    <div>
        <ul class="main-menu">
            <li><i class="fa-solid fa-people-group"></i>Thông tin
                <ul class="child-menu">
                    <li><a href="{% url 'admin_teacher_infor' %}" class="nav-item">Thông tin giảng viên</a></li>
                    <li><a href="{% url 'admin_student_infor' %}" class="nav-item">Thông tin sinh viên</a></li>
                </ul>
            </li>
        </ul>
    </div>  
    <a href="{% url 'event_management' %}" class="nav-item"><i class="fas fa-calendar-check"></i> Quản lý Sự kiện</a>
    <a href="{% url 'user_list' %}" class="nav-item"><i class="fas fa-users-cog"></i> Quản lý Người dùng</a>
    <!-- Đánh dấu active cho link Quản lý Học vụ -->
    <a href="{% url 'course_list' %}" class="nav-item active"><i class="fas fa-book-open"></i> Quản lý Học vụ</a>
{% endblock role_specific_links %}

<!-- 3. Chèn thông tin User Admin -->
{% block user_info %}
    <div class="get-username">
        Xin chào, {{ user_profile.userId }}<br> 
        <span style="font-size: 16px;">Admin</span>
    </div>
{% endblock user_info %}

<!-- 4. Nội dung chính -->
{% block content %}
<div style="padding: 20px; background-color: white; margin: 20px; border-radius: 8px;">
    
    <a href="{% url 'class_list' %}">&larr; Quay lại danh sách Lớp học</a>
    <h2 style="margin-top: 10px;">
        Gán Sinh viên cho Lớp: {{ class_obj.classId }}
    </h2>
    <p>
        <strong>Môn học:</strong> {{ class_obj.courseId.courseName }} | 
        <strong>Giảng viên:</strong> {{ class_obj.teacher.fullName }}
    </p>

    <!-- (Hiển thị messages (nếu có)) -->
    {% if messages %}
        {% for message in messages %}
            <div style="padding: 15px; margin: 20px 0; border-radius: 5px; background-color: {% if message.tags == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message.tags == 'success' %}#155724{% else %}#721c24{% endif %}; border: 1px solid {% if message.tags == 'success' %}#c3e6cb{% else %}#f5c6cb{% endif %};">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- 2 Cột: Thêm (Trái) và Xóa (Phải) -->
    <div class="manage-container">
        
        <!-- Cột Trái: Danh sách SV CHƯA CÓ TRONG LỚP -->
        <div class="student-list-box">
            <h4>Sinh viên chưa có trong lớp ({{ available_students.count }})</h4>
            <div class="student-list-content">
                <input type="text" id="search-available" onkeyup="filterAvailable()" placeholder="Tìm kiếm sinh viên...">
                
                <div id="available-list">
                    {% for student in available_students %}
                    <div class="student-item">
                        <div>
                            <strong>{{ student.fullName }}</strong>
                            <span> ({{ student.studentId_id }})</span>
                        </div>
                        <form method="POST" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="student_id" value="{{ student.studentId_id }}">
                            <button type="submit" name="action" value="add" class="btn btn-add">Thêm &rarr;</button>
                        </form>
                    </div>
                    {% empty %}
                    <p>Tất cả sinh viên đã có trong lớp này.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Cột Phải: Danh sách SV ĐÃ CÓ TRONG LỚP -->
        <div class="student-list-box">
            <h4>Sinh viên đã có trong lớp ({{ enrolled_students.count }})</h4>
            <div class="student-list-content">
                {% for student in enrolled_students %}
                <div class="student-item">
                    <div>
                        <strong>{{ student.fullName }}</strong>
                        <span> ({{ student.studentId_id }})</span>
                    </div>
                    <form method="POST" style="margin: 0;">
                        {% csrf_token %}
                        <input type="hidden" name="student_id" value="{{ student.studentId_id }}">
                        <button type="submit" name="action" value="remove" class="btn btn-remove">&larr; Xóa</button>
                    </form>
                </div>
                {% empty %}
                <p>Chưa có sinh viên nào trong lớp.</p>
                {% endfor %}
            </div>
        </div>
        
    </div>
</div>
{% endblock content %}

<!-- 5. JavaScript cho thanh Search -->
{% block scripts %}
<script>
function filterAvailable() {
    var input, filter, list, items, i, txtValue;
    input = document.getElementById("search-available");
    filter = input.value.toUpperCase();
    list = document.getElementById("available-list");
    items = list.getElementsByClassName("student-item");
    
    for (i = 0; i < items.length; i++) {
        txtValue = items[i].textContent || items[i].innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
            items[i].style.display = "flex";
        } else {
            items[i].style.display = "none";
        }
    }
}
</script>
{% endblock %}